FROM ubuntu:16.04
MAINTAINER Adrien BÃ©raud <adrien.beraud@savoirfairelinux.com>
RUN apt-get update \
	&& apt-get install -y llvm llvm-dev clang make cmake git wget libncurses5-dev libreadline-dev nettle-dev libgnutls28-dev libuv1-dev libmsgpack-dev libjsoncpp-dev libasio-dev cython3 python3-dev python3-setuptools libcppunit-dev python3-pip \
	&& apt-get remove -y gcc g++ && apt-get autoremove -y && apt-get clean

ENV CC cc
ENV CXX c++

#patch for https://github.com/Stiffstream/restinio-conan-example/issues/2
RUN pip3 install --upgrade cmake && cmake --version
#install conan & add restinio remotes
RUN pip3 install conan && \
    conan remote add stiffstream https://api.bintray.com/conan/stiffstream/public && \
    conan remote add public-conan https://api.bintray.com/conan/bincrafters/public-conan
#clone & setup restinio docker project
RUN git clone https://github.com/binarytrails/restinio-conan.git
#build restinio from source
RUN echo "*** Building RESTinio ***" \
	&& cd restinio-conan \
	&& mkdir build \
	&& cd build \
	&& conan install -o restinio:boost_libs=none --build=missing ..  \
    && conan install .. --build=missing
    #&& conan package --package-folder /usr .
#build http_parser fork
RUN echo "*** Building http_parser for custom HTTP methods ***" \
    && git clone https://github.com/eao197/http-parser.git \
    && cd http-parser && make && make install PREFIX=/usr \
    && cd ../ && rm -rf restinio-conan/

#build msgpack from source
RUN wget https://github.com/msgpack/msgpack-c/releases/download/cpp-2.1.5/msgpack-2.1.5.tar.gz \
	&& tar -xzf msgpack-2.1.5.tar.gz \
	&& cd msgpack-2.1.5 && mkdir build && cd build \
	&& cmake -DMSGPACK_CXX11=ON -DMSGPACK_BUILD_EXAMPLES=OFF -DCMAKE_INSTALL_PREFIX=/usr .. \
	&& make -j8 && make install \
	&& cd ../.. && rm -rf msgpack-2.1.5 msgpack-2.1.5.tar.gz
